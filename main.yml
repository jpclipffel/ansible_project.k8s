- hosts:
    - all

  tasks:

    - shell: >
        getent passwd {{ ansible_user_id }} | awk -F: '{ print $6 }'
      register: user_home
      tags:
        - always

    - name: Find kubeconfig
      set_fact:
        kubeconfig: "{{ user_home.stdout }}/.kube/admin.conf"
      when:
        - kubeconfig is not defined or kubeconfig | length < 1
      tags:
        - always

    # ---

    - name: Assertions
      include_tasks:
        file: assert.yml
      tags:
        - always

    # ---

    - name: Configure hosts
      include_role:
        name: common/docker_base
      tags:
        - install
        - configure
        - reset

    - name: Configure cluster
      include_role:
        name: common/k8s_base
      vars:
        k8s_base_node_type: "{{ facted.kubernetes.role }}"
        k8s_base_kubeconfig: "{{ kubeconfig }}"
        k8s_base_control_plane_endpoint: "{{ control_plane_endpoint }}"
      tags:
        - install
        - configure
        - bootstrap_master
        - bootstrap_worker
        - reset

    - name: Configure service mesh
      include_role:
        name: common/k8s_mesh
      vars:
        k8s_mesh_kubeconfig: "{{ kubeconfig }}"
      run_once: yes
      when:
        - facted.kubernetes.role == "master"
      tags:
        - apply
        - delete
