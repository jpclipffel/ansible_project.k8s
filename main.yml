- hosts:
    - all

  tasks:

    - include_tasks:
        file: helper_inventory.yml
        apply: { tags: [ always ] }
      tags:
        - always

# ---

- hosts:
    - masters
    - workers

  tasks:

    - name: Node type assertions
      assert:
        that:
          - k8s_node_type is defined and k8s_node_type in [ "master", "worker" ]
      tags:
        - always


    - name: Setup assertions
      assert:
        that:
          - k8s_control_plane_endpoint is defined and k8s_control_plane_endpoint is string
      tags:
        - setup


    - name: Configure container runtime
      include_role:
        name: common/docker_base
      tags:
        - setup
        - teardown


    - name: Set facts from playbook variables
      set_fact:
        k8s_base_node_type: "{{ k8s_node_type }}"
        k8s_base_control_plane_endpoint: "{{ k8s_control_plane_endpoint | default('-') }}"
        k8s_mesh_node_type: "{{ k8s_node_type }}"
      tags:
        - always


    - name: Configure Kubernetes
      include_role:
        name: common/k8s_base
      tags:
        - stats
        - setup
        - teardown


    - name: Configure Kubernetes service mesh
      include_role:
        name: common/k8s_mesh
      # when:
      #   - k8s_node_type == "master"
      tags:
        - stats
        - apply
        - delete
