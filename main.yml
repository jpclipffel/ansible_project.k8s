- hosts:
    - all

  tasks:

    - include_tasks:
        file: helper_inventory.yml
        apply: { tags: [ always ] }
      tags:
        - always

# ---

- hosts:
    - masters
    - workers

  tasks:

    - name: Assertions
      assert:
        that:
          - k8s_node_type is defined and k8s_node_type in [ "master", "worker" ]
          - k8s_control_plane_endpoint is defined and k8s_control_plane_endpoint is string
      tags:
        - always


    - name: Configure container runtime
      include_role:
        name: common/docker_base
      tags:
        - setup
        - teardown


    - name: Set facts from playbook variables
      set_fact:
        k8s_base_node_type: "{{ k8s_node_type }}"
        k8s_base_control_plane_endpoint: "{{ k8s_control_plane_endpoint }}"
      tags:
        - setup
        - teardown


    - name: Configure Kubernetes
      include_role:
        name: common/k8s_base
      tags:
        - setup
        - teardown


    - name: Configure Kubernetes service mesh
      include_role:
        name: common/k8s_mesh
      when:
        - k8s_node_type == "master"
      tags:
        - apply
        - delete
