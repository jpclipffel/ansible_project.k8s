- hosts:
    - all

  vars:
    definitions: [ calico.yml ]

  tasks:

    # --- Prepare K8S cluster ---
    # Tags: install, configure, reset

    - import_role:
        name: common/docker_base
  
    # --- Create and scale K8S cluster ---
    # Tags: install, configure, bootstrap_master, bootstrap_worker, reset

    - import_role:
        name: common/k8s_base


    # --- Extract Kubectl environment information ---
    - shell: >
        getent passwd {{ ansible_user_id | default(ansible_user) }} | awk -F: '{ print $6 }'
      register: user_home
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply
        - delete


    # --- Apply (deploy) K8S cluster ---
    # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # Tags: apply

    - name: Create temporary files
      tempfile:
        state: directory
      register: definitions
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply
        - delete

    - name: Copy definitions
      copy:
        src: "files/{{ item }}"
        dest: "{{ definitions.path }}/{{ item }}"
      with_items: 
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply
        - delete

    - name: Apply definitions
      shell: >
        kubectl apply -f {{ definitions.path }}/{{ item }}
      environment:
        KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
      with_items:
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply

    - name: Delete definitions
      shell: >
        kubectl apply -f {{ definitions.path }}/{{ item }}
      environment:
        KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
      with_items:
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete

    - name: Clean temporary files
      tempfile:
        state: absent
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply
        - delete


    # # --- Delete K8S cluster ---
    # # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # # Tags: delete

    # - tempfile:
    #     state: directory
    #   register: definitions
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - delete

    # - name: Copy definitions
    #   copy:
    #     src: "files/{{ item }}"
    #     dest: "{{ definitions.path }}/{{ item }}"
    #   with_items: 
    #     - calico.yml
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - delete

    # - name: Delete definitions
    #   shell: >
    #     kubectl apply -f {{ definitions.path }}/{{ item }}
    #   environment:
    #     KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
    #   with_items:
    #     - calico.yml
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - delete

    # - tempfile:
    #     path: "{{ definitions.path }}"
    #     state: absent
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - delete
