- hosts:
    - all

  vars:
    definitions: [ calico.yml ]
    kubeconfig_path: "{{ ansible_user_id | default(ansible_user) }}/.kube/admin.conf"
    kubeconfig: "{% if %}"

  tasks:

    # --- Prepare K8S cluster ---
    # Tags: install, configure, reset

    - import_role:
        name: common/docker_base

    # --- Create and scale K8S cluster ---
    # Tags: install, configure, bootstrap_master, bootstrap_worker, reset

    - import_role:
        name: common/k8s_base


    # --- Extract environment information ---
    - shell: >
        getent passwd {{ ansible_user_id | default(ansible_user) }} | awk -F: '{ print $6 }'
      register: user_home
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"


    # --- Apply (deploy) K8S cluster ---
    # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # Tags: apply

    - tempfile:
        state: directory
      register: definitions
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply

    - name: Copy definitions
      copy:
        src: "files/{{ item }}"
        dest: "{{ definitions.path }}/{{ item }}"
      with_items: 
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply

    - name: Apply definitions
      shell: >
        kubectl apply -f {{ definitions.path }}/{{ item }}
      environment:
        KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
      with_items:
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply

    - tempfile:
        state: absent
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply


    # --- Delete K8S cluster ---
    # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # Tags: delete

    - tempfile:
        state: directory
      register: definitions
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete

    - name: Copy definitions
      copy:
        src: "files/{{ item }}"
        dest: "{{ definitions.path }}/{{ item }}"
      with_items: 
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete

    - name: Delete definitions
      shell: >
        kubectl apply -f {{ definitions.path }}/{{ item }}
      environment:
        KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
      with_items:
        - calico.yml
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete

    - tempfile:
        state: absent
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete
