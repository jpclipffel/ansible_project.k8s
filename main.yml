- hosts:
    - all

  tasks:
    # --- Prepare K8S cluster ---
    # Tags: install, configure, reset

    - import_role:
        name: common/docker_base

    # --- Create and scale K8S cluster ---
    # Tags: install, configure, bootstrap_master, bootstrap_worker, reset

    - import_role:
        name: common/k8s_base


    # --- Apply (deploy) K8S cluster ---
    # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # Tags: apply

    - name: Deploy Calico
      k8s:
        kubeconfig: "{{ become_user | default(ansible_user) }}/.kube/admin.conf"
        state: present
        resource_definition: "{{ lookup('file', './calico.yml') }}"
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply

    # - name: Deploy Istio
    #   k8s:
    #     resource_definition: "{{ lookup('file', './calico.yml') }}"
    #   tags:
    #     - deploy

    # - name: Deploy KNative
    #   k8s:
    #     resource_definition: "{{ lookup('file', './calico.yml') }}"
    #   tags:
    #     - deploy

    # --- Reset K8S cluster ---
    # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # Tags: delete


    # --- Delete K8S cluster ---
    # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # Tags: delete

    - name: Remove Calico
      k8s:
        kubeconfig: "{{ become_user | defaults(ansible_user) }}/.kube/admin.conf"
        state: absent
        resource_definition: "{{ lookup('file', './calico.yml') }}"
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete
