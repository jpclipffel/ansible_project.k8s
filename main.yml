- hosts:
    - all

  # vars:
  #   definitions: [ calico.yml ]

  tasks:

    # --- Prepare hosts for the K8S cluster ---
    # Tags: install, configure, reset
    - import_role:
        name: common/docker_base
  
    # --- Manage the K8S cluster ---
    # Tags: install, configure, bootstrap_master, bootstrap_worker, reset
    - import_role:
        name: common/k8s_base
    
    # --- Manages the service mesh ---
    # Tags: apply, delete
    - import_role:
        name: common/k8s_mesh



    # # --- Extract Kubectl environment information ---
    # - shell: >
    #     getent passwd {{ ansible_user_id | default(ansible_user) }} | awk -F: '{ print $6 }'
    #   register: user_home
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - apply
    #     - delete


    # # --- Apply (deploy) K8S cluster ---
    # # TODO: Replace k8s local authentication with REST API authentication (more generic)
    # # Tags: apply

    # - name: Create temporary files
    #   tempfile:
    #     state: directory
    #   register: definitions
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - apply
    #     - delete

    # - name: Copy definitions
    #   copy:
    #     src: "files/{{ item }}"
    #     dest: "{{ definitions.path }}/{{ item }}"
    #   with_items: 
    #     - calico.yml
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - apply
    #     - delete

    # - name: Apply definitions
    #   shell: >
    #     kubectl apply -f {{ definitions.path }}/{{ item }}
    #   environment:
    #     KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
    #   with_items:
    #     - calico.yml
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - apply

    # - name: Delete definitions
    #   shell: >
    #     kubectl delete -f {{ definitions.path }}/{{ item }}
    #   environment:
    #     KUBECONFIG: "{{ user_home.stdout }}/.kube/admin.conf"
    #   with_items:
    #     - calico.yml
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #   tags:
    #     - delete

    # - name: Clean temporary files
    #   file:
    #     path: "{{ definitions.path }}"
    #     state: absent
    #   run_once: yes
    #   when:
    #     - k8s_base_node_type | default("") == "master"
    #     - definitions.path is defined
    #   tags:
    #     - apply
    #     - delete
