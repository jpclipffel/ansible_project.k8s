- hosts:
    - all

  tasks:

    # --- Container runtime ---

    - name: Install and configure container runtime
      include_role:
        name: common/docker_base
      tags:
        - install
        - configure
        - reset

    # --- Self-configuration and common assertions ---
    #
    # Thoses steps are required only for K8S cluster management.
    # Ignored for installation and reset steps.

    # - include_tasks:
    #     file: helper_kubeconfig.yml
    #     apply: { tags: [ always ] }
    #   tags:
    #     - cluster

    # - include_tasks:
    #     file: helper_assert.yml
    #     apply: { tags: [ always ] }
    #   tags:
    #     - cluster

    - assert:
        that: "{{ item }} is defined and {{ item }} | length > 0"
        fail_msg: "Undefined or empty variable '{{ item }}'"
      loop:
        - control_plane_endpoint
        - node_type
      tags:
        - cluster

    # --- Cluster management ---

    - name: Install and configure Kubernetes
      include_role:
        name: common/k8s_base
      vars:
        k8s_base_node_type: "{{ node_type | default('') }}"
        k8s_base_control_plane_endpoint: "{{ control_plane_endpoint | default('') }}"
      tags:
        - install
        - cluster
        - reset

    - name: Configure Kubernetes service mesh
      include_role:
        name: common/k8s_mesh
      run_once: yes
      when:
        - node_type == "master"
      tags:
        - apply
        - delete
