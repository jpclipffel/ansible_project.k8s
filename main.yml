# K8S - Main
# Builds, scales and configures a Kubernetes cluster.

- hosts:
    - k8s_masters
    - k8s_workers

  tasks:

    - include_tasks:
        file: helper_inventory.yml
        apply: { tags: [ always ] }
      tags:
        - always


    - name: Inventory assertions
      assert:
        that:
          - k8s_node_type is defined and k8s_node_type in [ "master", "worker" ]
      tags:
        - always


    - name: Setup assertions
      assert:
        that:
          - k8s_control_plane_endpoint is defined
      tags:
        - setup


    - name: Configure container runtime
      include_role:
        name: docker_base
      tags:
        - never
        - setup
        - teardown


    - name: Set facts from playbook variables
      set_fact:
        k8s_base_node_type: "{{ k8s_node_type }}"
        k8s_base_control_plane_endpoint: "{{ k8s_control_plane_endpoint | default('-') }}"
        k8s_mesh_node_type: "{{ k8s_node_type }}"
      tags:
        - always


    - name: Configure Kubernetes
      include_role:
        name: k8s_base
      tags:
        - never
        - stats
        - setup
        - teardown


    - name: Configure Helm
      include_role:
        name: 'k8s_helm'
      tags:
        - never
        - setup
        - remove


    - include_role: { name: 'k8s_calico' }
      when: "'k8s_calico' in k8s_roles"
      tags: [ never, apply, delete ]

    - include_role: { name: 'k8s_istio' }
      when: "'k8s_istio' in k8s_roles"
      tags: [ never, apply, delete ]

    - include_role: { name: 'k8s_prometheus' }
      when: "'k8s_prometheus' in k8s_roles"
      tags: [ never, apply, delete ]

    - include_role: { name: 'k8s_gitlab' }
      when: "'k8s_gitlab' in k8s_roles"
      tags: [ never, apply, delete ]
