- hosts:
    - masters
    - workers

  tasks:

    - include_tasks:
        file: helper_inventory.yml
        apply: { tags: [ always ] }
      tags:
        - always


    - name: Inventory assertions
      assert:
        that:
          - k8s_node_type is defined and k8s_node_type in [ "master", "worker" ]
      tags:
        - always


    - name: Setup assertions
      assert:
        that:
          - k8s_control_plane_endpoint is defined
      tags:
        - setup


    - name: Configure container runtime
      include_role:
        name: common/docker_base
      tags:
        - setup
        - teardown


    - name: Set facts from playbook variables
      set_fact:
        k8s_base_node_type: "{{ k8s_node_type }}"
        k8s_base_control_plane_endpoint: "{{ k8s_control_plane_endpoint | default('-') }}"
        k8s_mesh_node_type: "{{ k8s_node_type }}"
      tags:
        - always


    - name: Configure Kubernetes
      include_role:
        name: common/k8s_base
      tags:
        - stats
        - setup
        - teardown


    # - name: Configure Kubernetes service mesh
    #   include_role:
    #     name: common/k8s_mesh
    #   # when:
    #   #   - k8s_node_type == "master"
    #   tags:
    #     - stats
    #     - apply
    #     - delete


    - include_role: { name: 'k8s_calico' }
      when: "'k8s_calico' in k8s_roles"
      tags: [ apply, delete ]


    - include_role: { name: 'k8s_istio' }
      when: "'k8s_istio' in k8s_roles"
      tags: [ apply, delete ]
