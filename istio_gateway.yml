- hosts:
    - all

  tasks:
    - name: Handle manifest
      include_tasks:
        file: helper_manifest.yml
      vars:
        - manifest: "{{ manifest }}"
      tags:
        - apply
        - delete
  
    - shell: >
        echo $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')
      environment:
        KUBECONFIG: "{{ k8s_mesh_kubeconfig }}"
      register: "istio_http_nodePort"
      tags:
        - apply

    - name: Set Istio mesh information
      set_stats:
        data:
          k8s_mesh_istio_http_nodePort: "{{ istio_http_nodePort.stdout }}"
      tags:
        - apply
