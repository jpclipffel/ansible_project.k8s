- hosts:
    - all

  tasks:

    - include_tasks:
        file: helper_kubeconfig.yml

    - include_tasks:
        file: helper_assert.yml

    - assert:
        that: "{{ item }} is defined and {{ item }} | length > 0"
        fail_msg: "Undefined or empty variable '{{ item }}'"
      with_items:
        - manifest
        - gateway_name

    # ---

    - include_tasks:
        file: helper_manifest.yml
      vars:
        - manifest: "{{ manifest }}"
      tags:
        - apply
        - delete
  
    - shell: >
        echo $(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="http2")].nodePort}')
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      register: "nodePort"
      tags:
        - apply

    - name: Set Istio mesh information
      set_stats:
        data:
          istio_gateway_nodePort: "{{ nodePort.stdout }}"
      tags:
        - apply
