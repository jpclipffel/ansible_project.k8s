- hosts:
    - all

  tasks:

    - name: Kubeconfig
      include_tasks:
        file: kubeconfig.yml
      tags:
        - always

    - name: Assertions (project)
      include_tasks:
        file: assert.yml
      tags:
        - always
  
    - name: Assertions (playbook)
      fail:
        msg: >
          Undefined or empty variable 'manifest'
          manifest: {{ manifest | default('not defined') }}
      run_once: yes
      when:
        - manifest is not defined or manifest | length < 1
      tags:
        - always

    # ---

    - tempfile:
        state: file
      register: _manifest
      run_once: yes
      # when:
      #   - facted.kubernetes.roles is defined
      #   - facted.kubernetes.roles == master
      tags:
        - apply
        - delete

    - template:
        src: "{{ manifest }}"
        dest: "{{ _manifest.path }}"
      run_once: yes
      # when:
      #   - facted.kubernetes.roles is defined
      #   - facted.kubernetes.roles == master
      tags:
        - apply
        - delete

    # --- Apply and Delete

    - name: Apply
      shell: >
        kubectl apply -f {{ _manifest.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      run_once: yes
      # when:
      #   - facted.kubernetes.roles is defined
      #   - facted.kubernetes.roles == master
      tags:
        - apply

    - name: Delete
      shell: >
        kubectl delete -f {{ _manifest.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      run_once: yes
      # when:
      #   - facted.kubernetes.roles is defined
      #   - facted.kubernetes.roles == master
      tags:
        - delete
