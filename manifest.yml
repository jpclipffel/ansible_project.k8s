- hosts:
    - all

  tasks:
    - include_tasks:
        file: "{{ __item }}"
        apply: { tags: [ always ] }
      with_items:
        - helper_inventory.yml
        - helper_kubeconfig.yml
      loop_control:
        loop_var: __item
      tags:
        - always

# ---

- hosts:
    - masters

  tasks:
    - block:
        # ---
        - name: Assertions
          assert:
            that:
              - manifest is defined and manifest | length > 0
          tags:
            - always
        # ---
        - name: Create manifest temporary file
          tempfile:
            state: file
          register: _manifest
          tags:
            - apply
            - delete
        # ---
        - name: Template manifest
          template:
            src: "{{ manifest }}"
            dest: "{{ _manifest.path }}"
          tags:
            - apply
            - delete
        # ---
        - name: Apply manifest
          shell: >
            kubectl apply -f {{ _manifest.path }}
          environment:
            KUBECONFIG: "{{ k8s_kubeconfig }}"
          tags:
            - apply
        # ---
        - name: Delete manifest
          shell: >
            kubectl delete -f {{ _manifest.path }}
          environment:
            KUBECONFIG: "{{ k8s_kubeconfig }}"
          tags:
            - delete
        # ---
      run_once: yes
