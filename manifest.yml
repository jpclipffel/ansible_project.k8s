- hosts:
    - all

  tasks:

    # ---

    - fail:
        msg: "Variable 'kubeconfig' is not defined or empty"
      run_once: yes
      when:
        - kubeconfig is not defined or kubeconfig | length < 1
      tags:
        - always
  
    - fail:
        msg: "Variable 'manifest' is not defined or empty"
      run_once: yes
      when:
        - manifest is not defined or manifest | length < 1
      tags:
        - always

    # ---

    - tempfile:
        state: file
      register: _manifest
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply
        - delete

    - template:
        src: "{{ manifest }}"
        dest: "{{ _manifest.path }}"
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply
        - delete

    # ---

    - name: Apply
      shell: >
        kubectl apply -f {{ _manifest.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - apply

    - name: Delete
      shell: >
        kubectl delete -f {{ _manifest.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      run_once: yes
      when:
        - k8s_base_node_type | default("") == "master"
      tags:
        - delete
