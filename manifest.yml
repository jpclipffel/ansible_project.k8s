- hosts:
    - all

  tasks:

    # --- Setup KUBECONFIG ---

    - name: Kubeconfig
      include_tasks:
        file: helper_kubeconfig.yml
      tags:
        - always

    # --- Assertions ---

    - name: Assertions (project)
      include_tasks:
        file: helper_assert.yml
      vars:
        control_plane_endpoint: "-"
      tags:
        - always

    - name: Manifest assertions
      fail:
        msg: >
          Undefined or empty variable 'manifest'
          manifest: {{ manifest | default('not defined') }}
      run_once: yes
      when:
        - manifest is not defined or manifest | length < 1
      tags:
        - always

    - name: Tags assertion
      fail:
        msg: >
          Cannot specify both 'apply' and 'delete' in tags
      when:
        - "'apply' in ansible_run_tags"
        - "'delete' in ansible_run_tags"
      tags:
        - always

    # --- Prepare deployment ---

    - tempfile:
        state: file
      register: _manifest
      run_once: yes
      when:
        - facted.kubernetes.role == 'master'
      tags:
        - apply
        - delete

    - template:
        src: "{{ manifest }}"
        dest: "{{ _manifest.path }}"
      run_once: yes
      when:
        - facted.kubernetes.role == 'master'
      tags:
        - apply
        - delete

    # --- Apply | Delete ---

    - name: Apply manifest
      shell: >
        kubectl apply -f {{ _manifest.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      run_once: yes
      when:
        - facted.kubernetes.role == 'master'
      tags:
        - apply

    - name: Delete manifest
      shell: >
        kubectl delete -f {{ _manifest.path }}
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
      run_once: yes
      when:
        - facted.kubernetes.role == 'master'
      tags:
        - delete
